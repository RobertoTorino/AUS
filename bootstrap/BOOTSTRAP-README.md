# CDK Bootstrap

### The cdk bootstrap command creates a CloudFormation Stack named CDKToolkit.

#### This stack contains 5 IAM Roles:
- **CloudFormationExecutionRole**
- **DeploymentActionRole**
- **LookupRole** 
- **FilePublishingRole** 
- **ImagePublishingRole**
  
## IAM Roles created by CDK Bootstrap:

### CloudFormationExecutionRole
CloudFormation will use this role when you deploy a stack from your local machine with the "cdk deploy" command and through CDK Pipelines for CI/CD. The CloudFormationExecutionRole must have permissions to list, create, modify and delete all the resources we use in our Stacks. For example, if our Stack contains a Lambda function, CloudFormation must have permission to create it. To allow creating any kind of resources with CDK, this role has "arn:aws:iam::aws:policy/AdministratorAccess" Policy assigned by default. It gives full access to our account, allowing to do anything. Thatâ€™s against the least privilege principle.

### DeploymentActionRole
The CDK CLI and CDK Pipelines assume this role to create and manage CloudFormation Stacks and the files in a CDK assets S3 Bucket. It also allows passing the CloudFormationExecutionRole to CloudFormation. Then CloudFormation can use it to create, update and delete resources. The DeploymentActionRole allows accessing and managing objects in S3 Buckets on other accounts, which is needed for cross-account deployments.

### LookupRole
CDK CLI uses the LookupRole when it needs to get information about the already existing resources you want to use in your CDK app. Those resources include Route53 Hosted Zones, VPCs, SSM Parameters, and a few others. The LookupRole uses a ReadOnlyAccess IAM Policy, which gives it access to read everything, not only the resources the CDK can do a lookup for. Because "kms:Decrypt" is  excluded from this through the second Policy attached to the LookupRole it can not be used to read encrypted data and secrets.

### FilePublishingRole and ImagePublishingRole
Those two roles allow CDK uploading and managing assets (like Lambda function sources) in the CDK assets bucket and container images in the CDK ECR repository.
Those assets and images are built from our application code, uploaded by the CDK, and then referenced in the CloudFormation Stacks.

## Creating your own CloudFormation Execution Policy
Create your own IAM Policy. It should only allow access to the AWS services you use in the CDK app. It needs broad access to those selected services. Give it full access with an asterisk wildcard (*). Limit access to only the region where you operate, eu-west-1. Some services, like CloudFront, are global, so we list them separately with no region restriction permissions to the IAM actions. IAM as a service, managing access to other AWS components, is critical to security, it has over 200 actions, select only the ones required for the Stacks to work. Exclude access to the roles generated by the CDK and the policy itself for additional protection.

```shell
aws iam create-policy \
--policy-name cdkCFExecutionPolicy \
--policy-document file://cdk-cf-execution-policy.json \
--description "Special bootstrap policy for the AWS CDK toolkit." \
--tags '{"Key": "Application", "Value": "cdk-toolkit"}' '{"Key": "Stage", "Value": "prod"}'
```

### Updating the Policy
Over time more services are added. This requires to extend the "cdkCFExecutionPolicy" with access to additional services.
To do this modify the definition in the cdkCFExecutionPolicy.json. Then create a new Policy version and set it as a default one:

```shell 
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
aws iam create-policy-version \
--policy-arn arn:aws:iam::$ACCOUNT_ID:policy/cdkCFExecutionPolicy \
--policy-document file://cdk-cf-execution-policy.json \
--set-as-default
```

From then on, the CDK will be using an updated Policy.

There is a limit to 5 Policy versions, delete old versions to make updates.

```shell 
aws iam list-policy-versions \
--policy-arn arn:aws:iam::983082685788:policy/cdkCFExecutionPolicy
```

Delete the selected old version:

```shell 
aws iam delete-policy-version \
--policy-arn arn:aws:iam::$ACCOUNT_ID:policy/cdkCFExecutionPolicy \
--version-id <VERSION>
```

